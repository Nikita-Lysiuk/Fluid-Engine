#version 460

layout(local_size_x = 64) in;

layout(set = 0, binding = 0, std430) buffer PosBuffer {
    vec4 p[];
} positions;

layout(set = 0, binding = 1, std430) buffer VelBuffer {
    vec4 v[];
} velocities;

layout(set = 0, binding = 2, std430) buffer ColBuffer {
    vec4 c[];
} colors;

layout(set = 0, binding = 3, std140) uniform Params {
    float particle_radius;
    float particle_mass;
    float smoothing_radius;
    float target_density;
    vec4 gravity;
    vec4 box_min;
    vec4 box_max;
} params;

layout(push_constant) uniform PushConstants {
    float dt;
    uint particle_count;
} pc;

void main() {
    uint i = gl_GlobalInvocationID.x;
    if (i >= positions.p.length()) return;

    vec3 pos = positions.p[i].xyz;
    vec3 vel = velocities.v[i].xyz;

    vel += params.gravity.xyz * pc.dt;
    pos += vel * pc.dt;

    if (pos.y < params.box_min.y) {
        pos.y = params.box_min.y;
        vel.y *= -0.5;
    }

    positions.p[i] = vec4(pos, 1.0);
    velocities.v[i] = vec4(vel, 0.0);

    float speed = length(vel);
    vec3 col = mix(vec3(0, 0, 1), vec3(1, 1, 1), clamp(speed / 5.0, 0, 1));
    colors.c[i] = vec4(col, 1.0);
}